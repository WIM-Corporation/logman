<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loki &mdash; logman 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=d45e8c67"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Recipes" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            logman
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../documentation/index.html">Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Recipes</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Loki</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/WIM-Corporation/logman">Github</a></li>
<li class="toctree-l1"><a class="reference external" href="https://en.wimcorp.co.kr/">Contact us</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">logman</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Recipes</a></li>
      <li class="breadcrumb-item active">Loki</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/recipes/loki.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="loki">
<h1>Loki<a class="headerlink" href="#loki" title="Link to this heading"></a></h1>
<section id="integrating-python-applications-with-grafana-loki">
<h2>Integrating Python Applications with Grafana Loki<a class="headerlink" href="#integrating-python-applications-with-grafana-loki" title="Link to this heading"></a></h2>
<p>When aiming to send logs from your Python application to Grafana Loki, using a JSON format for logs can simplify label management and enhance log organization. <cite>logman</cite> facilitates this by leveraging Python’s standard logging module to perform JSON formatting and store log files that can be tailed by agents.</p>
<p>This guide will walk you through the process of setting up <cite>logman</cite> to send logs to Loki using both Promtail and Grafana Agent.</p>
<section id="why-json-formatting">
<h3>Why JSON Formatting?<a class="headerlink" href="#why-json-formatting" title="Link to this heading"></a></h3>
<p>JSON formatting allows for better structured logs, making it easier to parse and manage labels in Loki. With <cite>logman</cite>, you can seamlessly integrate JSON formatting into your Python application’s logging setup.</p>
</section>
</section>
<section id="setup-and-deployment">
<h2>Setup and Deployment<a class="headerlink" href="#setup-and-deployment" title="Link to this heading"></a></h2>
<p>In this section, we’ll use a simple Python application that generates random numbers and logs them. We’ll deploy this application and Promtail using Docker Compose. Promtail will track the log files and send them to Loki.</p>
<section id="step-1-python-application">
<h3>Step 1: Python Application<a class="headerlink" href="#step-1-python-application" title="Link to this heading"></a></h3>
<p>Create a simple Python application that logs random numbers. Save this as <cite>main.py</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">logman</span> <span class="kn">import</span> <span class="n">LoggerFactory</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">logRandomNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated random number: </span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Bar</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">logRandomNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated random number: </span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">Bar</span><span class="p">()</span>

    <span class="c1"># Create threads for Foo and Bar logging</span>
    <span class="n">foo_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">foo</span><span class="o">.</span><span class="n">logRandomNumber</span><span class="p">)</span>
    <span class="n">bar_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">bar</span><span class="o">.</span><span class="n">logRandomNumber</span><span class="p">)</span>

    <span class="c1"># Start the threads</span>
    <span class="n">foo_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">bar_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Join the threads to the main thread to keep them running</span>
    <span class="n">foo_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">bar_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="step-2-docker-compose-setup">
<h3>Step 2: Docker Compose Setup<a class="headerlink" href="#step-2-docker-compose-setup" title="Link to this heading"></a></h3>
<p>Create a <cite>docker-compose.yml</cite> file to define the services. This setup will include the Python application and Promtail.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.8&#39;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">app</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app.dockerfile</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:/app/logs</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PYTHONUNBUFFERED=1</span>

<span class="w">  </span><span class="nt">loki</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana/loki:2.9.2</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;3100:3100&#39;</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-config.file=/etc/loki/local-config.yaml</span>

<span class="w">  </span><span class="nt">grafana</span><span class="p">:</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GF_PATHS_PROVISIONING=/etc/grafana/provisioning</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GF_AUTH_ANONYMOUS_ENABLED=true</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GF_AUTH_ANONYMOUS_ORG_ROLE=Admin</span>
<span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sh</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-euc</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">mkdir -p /etc/grafana/provisioning/datasources</span>
<span class="w">        </span><span class="no">cat &lt;&lt;EOF &gt; /etc/grafana/provisioning/datasources/ds.yaml</span>
<span class="w">        </span><span class="no">apiVersion: 1</span>
<span class="w">        </span><span class="no">datasources:</span>
<span class="w">        </span><span class="no">- name: Loki</span>
<span class="w">          </span><span class="no">type: loki</span>
<span class="w">          </span><span class="no">access: proxy</span>
<span class="w">          </span><span class="no">orgId: 1</span>
<span class="w">          </span><span class="no">url: http://loki:3100</span>
<span class="w">          </span><span class="no">basicAuth: false</span>
<span class="w">          </span><span class="no">isDefault: true</span>
<span class="w">          </span><span class="no">version: 1</span>
<span class="w">          </span><span class="no">editable: false</span>
<span class="w">        </span><span class="no">EOF</span>
<span class="w">        </span><span class="no">/run.sh</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana/grafana:latest</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;3000:3000&#39;</span>

<span class="w">  </span><span class="nt">promtail</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana/promtail:2.9.2</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:/var/logs</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./promtail-config.yml:/etc/promtail/promtail-config.yml</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-config.file=/etc/promtail/promtail-config.yml</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">logs</span><span class="p">:</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The provided docker-compose.yml file is an example configuration for development and testing purposes.
For production, it is recommended to set up Grafana and Loki separately to better manage and scale your logging infrastructure.</p>
</div>
</section>
<section id="step-3-promtail-configuration">
<h3>Step 3: Promtail Configuration<a class="headerlink" href="#step-3-promtail-configuration" title="Link to this heading"></a></h3>
<p>Create a <cite>promtail-config.yml</cite> file to configure Promtail to send logs to Loki.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">server</span><span class="p">:</span>
<span class="w">  </span><span class="nt">http_listen_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9080</span>
<span class="w">  </span><span class="nt">grpc_listen_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>

<span class="nt">positions</span><span class="p">:</span>
<span class="w">  </span><span class="nt">filename</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/positions.yaml</span>

<span class="nt">clients</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://loki:3100/loki/api/v1/push</span>

<span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logman</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pylogs</span>
<span class="w">          </span><span class="nt">__path__</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/logs/*.log</span>
<span class="w">          </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Ensure that you customize the clients URL to match your Loki server’s address, especially if it’s hosted remotely or under a different port.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">clients</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">url</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">YOUR_LOKI_SERVER</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">YOUR_LOKI_PORT</span><span class="o">&gt;/</span><span class="n">loki</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">push</span>

<span class="n">scrape_configs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">job_name</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_JOB_NAME</span><span class="o">&gt;</span>
    <span class="n">static_configs</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">targets</span><span class="p">:</span>
          <span class="o">-</span> <span class="o">&lt;</span><span class="n">YOUR_TARGET</span><span class="o">&gt;</span>
        <span class="n">labels</span><span class="p">:</span>
          <span class="n">job</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_JOB_LABEL</span><span class="o">&gt;</span>
          <span class="n">__path__</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR_LOG_PATH</span><span class="o">&gt;</span>
          <span class="o">...</span>
</pre></div>
</div>
</div>
</section>
<section id="step-4-build-and-run">
<h3>Step 4: Build and Run<a class="headerlink" href="#step-4-build-and-run" title="Link to this heading"></a></h3>
<p>Build and run the Docker Compose setup to start the Python application and Promtail.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker-compose<span class="w"> </span>up<span class="w"> </span>--build
</pre></div>
</div>
<p>This command builds the Docker images and starts the containers. Promtail will start tailing the log files generated by the Python application and send them to Loki.</p>
</section>
<section id="step-5-viewing-logs-in-grafana">
<h3>Step 5: Viewing Logs in Grafana<a class="headerlink" href="#step-5-viewing-logs-in-grafana" title="Link to this heading"></a></h3>
<p>After starting the Docker Compose setup, you can view the logs in Grafana. Follow these steps:</p>
<ol class="arabic simple">
<li><p>Open your web browser and navigate to <cite>http://localhost:3000</cite>.</p></li>
<li><p>You will be automatically logged in as an anonymous user with admin privileges.</p></li>
<li><p>In the Grafana dashboard, click on the <strong>Explore</strong> icon on the left sidebar.</p></li>
<li><p>In the <strong>Explore</strong> view, select <strong>Loki</strong> as the data source from the dropdown at the top.</p></li>
<li><p>Enter the following query to view the logs:</p></li>
</ol>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{job=&quot;pylogs&quot;, environment=&quot;production&quot;}
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="6">
<li><p>Press <strong>Run query</strong> to fetch and display the logs from Loki.</p></li>
</ol>
<p>You should see the logs generated by your Python application, formatted as JSON, and sent to Loki by Promtail. This allows you to monitor your application logs in real-time and utilize Grafana’s powerful visualization and querying capabilities.</p>
<img alt="Grafana Explore view" src="../_images/loki.png" />
<p>With this setup, you have successfully integrated your Python application’s logging with Grafana Loki, enabling efficient log management and analysis.</p>
</section>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading"></a></h2>
<p>Using logman with JSON formatting simplifies the management of logs in your Python application. By integrating with tools like Promtail or Grafana Agent, you can efficiently send these logs to Grafana Loki for centralized logging and monitoring.</p>
<p>For more detailed examples and advanced configurations, explore the individual modules and classes in the documentation. If you have any questions or need further assistance, please feel free to reach out to our support team.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Recipes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, WIM Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>